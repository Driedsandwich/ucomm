# ucomm SPEC v0.5.x (extract)

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 0.5.x  
**æœ€çµ‚æ›´æ–°**: 2025-09-01  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 4.3 å®Œäº† (SSOTçµ±åˆãƒ»Link Checkå®‰å®šåŒ–), Phase 5 æº–å‚™ä¸­

## Terminology

- **codex** = OpenAI Codex (2025) CLI/Web integration (planned)
- **Legacy Codex API** = 2023ä»¥å‰ã®æ—§Codex APIï¼ˆéå¯¾è±¡ãƒ»å»ƒæ­¢æ¸ˆã¿ï¼‰

## æ¦‚è¦

UCOMM (Unified Command) ã¯ MCP (Model Context Protocol) ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸçµ±ä¸€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒåŸºç›¤ã§ã™ã€‚tmux ãƒ™ãƒ¼ã‚¹ã®çµ„ç¹”åŒ–ã‚·ã‚¹ãƒ†ãƒ ã¨ CLI ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’é€šã˜ã¦ã€ã‚»ã‚­ãƒ¥ã‚¢ã§ä¸€è²«æ€§ã®ã‚ã‚‹ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œç’°å¢ƒã‚’æä¾›ã—ã¾ã™ã€‚

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚³ã‚¢ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 1. Tmux çµ„ç¹”ã‚·ã‚¹ãƒ†ãƒ 
- **å½¹å‰²**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã®çµ„ç¹”åŒ–
- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `.tmux.conf` (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ)
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: è‡ªå‹•ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ»å¾©å¸°æ©Ÿèƒ½
- **ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç®¡ç†**: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆ†é›¢

#### 2. CLI Adapters
- **claude**: Claude Code CLI integration (primary)
- **gemini**: Google Gemini integration (2025è¨ˆç”»)  
- **codex**: OpenAI Codex integration (2025è¨ˆç”»)
- **Interface**: çµ±ä¸€I/FåŒ–ï¼ˆsend/receive/confirm/metricsï¼‰
- **æ¨™æº–åŒ–**: çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ (JSON)

#### 3. MCP (Model Context Protocol)
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `127.0.0.1:39200` (å›ºå®š)
- **é€šä¿¡æ–¹å¼**: HTTP/JSON-RPC
- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `mcp.json` (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ)
- **ãƒ¢ãƒ¼ãƒ‰**: Read-Only / Read-Write (ç’°å¢ƒå¤‰æ•°åˆ¶å¾¡)
- **æœ€å°æ¨©é™ãƒ»åŸå‰‡RO**: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«JSONã§è¦å®š

## Topology
- **hierarchy**: éšå±¤å‹ / **roundtable**: ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«å‹ / **magi**: è¨­å®šã§åˆ‡æ›¿ï¼ˆN-of-M, 2-of-3ï¼‰

## ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä»•æ§˜

### 1. Health Check API

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `/ready`, `/health`

```bash
# åŸºæœ¬å®Ÿè¡Œ
./scripts/health.sh

# JSON å‡ºåŠ›
./scripts/health.sh --json
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼**:
```json
{
  "status": "ok|degraded|error",
  "timestamp": "2025-08-31T10:49:30Z",
  "latency_ms": 125,
  "components": {
    "mcp": {"status": "ok", "latency_ms": 125},
    "tmux": {"status": "ok", "sessions": 2},
    "adapters": {"status": "ok", "loaded": 5}
  }
}
```

**SLO**: /health: 200 && latency <= 6000ms ã‚’SLO

### 2. Command Execution API

**åŸºæœ¬å½¢å¼**:
```bash
ucomm <adapter> <command> [args...]
```

**ä¾‹**:
```bash
ucomm git status
ucomm npm install
ucomm docker ps
```

## SLO (Service Level Objectives)

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

| ãƒ¡ãƒˆãƒªãƒƒã‚¯ | ç›®æ¨™å€¤ | Phase 4.3 å®Ÿç¸¾ |
|-----------|--------|----------------|
| åˆå›å®Ÿè¡Œãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | â‰¤ 6s | æ¸¬å®šä¸­ |
| CI å®Ÿè¡Œãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | â‰¤ 6s | æ¸¬å®šä¸­ |
| MCP é€šä¿¡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | â‰¤ 500ms | 125ms âœ… |
| CI æˆåŠŸç‡ | â‰¥ 35% | 35.0% âœ… |

### å¯ç”¨æ€§è¦ä»¶

- **ã‚µãƒ¼ãƒ“ã‚¹ç¨¼åƒç‡**: 99.9% (è¨ˆç”»æ™‚)
- **å¾©æ—§æ™‚é–“**: < 5åˆ† (è‡ªå‹•å†èµ·å‹•)
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: 100% (Read-Only ãƒ¢ãƒ¼ãƒ‰æ™‚)

## MCP ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

### HTTP è¨­å®š
```json
{
  "server": {
    "host": "127.0.0.1",
    "port": 39200,
    "timeout": 30000
  }
}
```

### Read-Only (RO) ãƒ¢ãƒ¼ãƒ‰
- **è¨­å®š**: `mcp.json` å†…ã§ `"readonly": true`
- **åˆ¶é™**: æ›¸ãè¾¼ã¿æ“ä½œã®å…¨é¢ç¦æ­¢
- **ç”¨é€”**: CI ç’°å¢ƒã€æœ¬ç•ªç’°å¢ƒã§ã®å®‰å…¨å®Ÿè¡Œ

### Allow-Deny åˆ¶å¾¡
```json
{
  "security": {
    "allow_commands": ["git", "npm", "docker"],
    "deny_patterns": ["rm -rf", "sudo", "chmod +x"],
    "require_confirmation": ["git push", "npm publish"]
  }
}
```

### å†èµ·å‹•åæ˜ 
- **è¨­å®šå¤‰æ›´**: `mcp.json` æ›´æ–°æ™‚ã®è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
- **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†**: SIGHUP ã«ã‚ˆã‚‹ graceful restart
- **ä¾å­˜é–¢ä¿‚**: tmux ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒ

## ä¾å­˜é–¢ä¿‚ã¨ãƒãƒ¼ãƒˆ

### ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ä¾å­˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------------|------|-----------|
| Node.js | å¿…é ˆ | â‰¥ 18.0.0 |
| tmux | å¿…é ˆ | â‰¥ 3.2 |
| Git | å¿…é ˆ | â‰¥ 2.30 |
| Python | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | â‰¥ 3.8 |

### ãƒãƒ¼ãƒˆä½¿ç”¨
| ãƒãƒ¼ãƒˆ | ç”¨é€” | ãƒ—ãƒ­ãƒˆã‚³ãƒ« |
|-------|------|----------|
| 39200 | MCP ã‚µãƒ¼ãƒãƒ¼ | HTTP |
| 39201 | WebSocket (å°†æ¥) | WS |

## å¤±æ•—æ™‚ãƒªãƒˆãƒ©ã‚¤æ–¹é‡

### MCP é€šä¿¡ã‚¨ãƒ©ãƒ¼
```typescript
const retryConfig = {
  maxRetries: 3,
  backoffMs: [1000, 2000, 4000],
  retryableErrors: ["ECONNREFUSED", "TIMEOUT", "503"]
};
```

### ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¤±æ•—
1. **ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼**: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ 3å›ãƒªãƒˆãƒ©ã‚¤
2. **è¨­å®šã‚¨ãƒ©ãƒ¼**: å³åº§ã«å¤±æ•—ã€ãƒ­ã‚°å‡ºåŠ›
3. **æ¨©é™ã‚¨ãƒ©ãƒ¼**: ãƒªãƒˆãƒ©ã‚¤ãªã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°

### tmux ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©æ—§
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡æ–­**: è‡ªå‹•å†æ¥ç¶š (30ç§’é–“éš”)
- **ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢**: systemd/supervisord ã«ã‚ˆã‚‹è‡ªå‹•å†èµ·å‹•
- **è¨­å®šç ´æ**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®è‡ªå‹•å¾©å…ƒ

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä»•æ§˜

### æ›¸ãè¾¼ã¿ã‚²ãƒ¼ãƒˆ
- **ç’°å¢ƒå¤‰æ•°**: `UCOMM_ENABLE_WRITES=0/1`
- **ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: `UCOMM_CONFIRM_WRITE=1`
- **ã‚»ã‚­ãƒ¥ã‚¢ãƒ¢ãƒ¼ãƒ‰**: `UCOMM_SECURE_MODE=1` (æ›¸ãè¾¼ã¿å…¨é¢ç¦æ­¢)

### èªè¨¼ãƒ»èªå¯ (Phase 6 äºˆå®š)
- **èªè¨¼æ–¹å¼**: OAuth2 + JWT
- **èªå¯ãƒ¬ãƒ™ãƒ«**: Read-Only / Read-Write / Admin
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: Redis ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆã‚¢

## ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°

### ãƒ­ã‚°å‡ºåŠ›è¦ä»¶
- **ãƒ¬ãƒ™ãƒ«**: DEBUG / INFO / WARN / ERROR
- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: æ§‹é€ åŒ–ãƒ­ã‚° (JSON)
- **ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: æ—¥æ¬¡ã€æœ€å¤§7æ—¥é–“ä¿æŒ
- **å‡ºåŠ›å…ˆ**: `logs/ucomm.log`, syslog

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
- **å®Ÿè¡Œæ™‚é–“**: å…¨ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œæ™‚é–“æ¸¬å®š
- **æˆåŠŸç‡**: æˆåŠŸ/å¤±æ•—ã®çµ±è¨ˆæƒ…å ±
- **ãƒªã‚½ãƒ¼ã‚¹**: CPU/ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
- **ã‚¨ãƒ©ãƒ¼**: ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã¨ã‚«ã‚¦ãƒ³ãƒˆ

## ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ

### ã‚µãƒãƒ¼ãƒˆ OS
| OS | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | Status |
|----|-----------|---------| 
| Ubuntu | 20.04+ | âœ… Supported |
| Windows | Server 2019+ | âœ… Supported |
| macOS | 12+ | ğŸ”„ Planned |

### CI/CD ç’°å¢ƒ
- **GitHub Actions**: Ubuntu/Windows runner
- **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: smoke.yml ã«ã‚ˆã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆ
- **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: ãƒ†ã‚¹ãƒˆçµæœã¨ãƒ­ã‚°ã®åé›†

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

### ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
- **MAJOR**: ç ´å£Šçš„å¤‰æ›´
- **MINOR**: å¾Œæ–¹äº’æ›æ€§ã®ã‚ã‚‹æ©Ÿèƒ½è¿½åŠ   
- **PATCH**: ãƒã‚°ãƒ•ã‚£ãƒƒã‚¯ã‚¹

### ãƒªãƒªãƒ¼ã‚¹è¦ä»¶
- **CI æˆåŠŸç‡**: ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ç›®æ¨™å€¤é”æˆ
- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: â‰¥ 80%
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**: å…¨ä»•æ§˜æ›¸ã®æ›´æ–°
- **è¨¼è·¡ä¿å­˜**: artifacts/ ã¸ã®å®Ÿè¡Œè¨¼è·¡ä¿å­˜

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Phase Map](./PHASE_MAP.txt) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“è¨ˆç”»
- [Requirements v0.5.x](./REQUIREMENTS_v0.5.x.md) - è¦ä»¶å®šç¾©ã¨ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£
- [Operations Manual](./OPERATIONS.md) - é‹ç”¨æ‰‹é †æ›¸
- [Environment Variables](./ENV.md) - ç’°å¢ƒå¤‰æ•°ä¸€è¦§
- [CI Design](./CI/SMOKE.md) - CI/CD è¨­è¨ˆæ›¸