#!/usr/bin/env bash
set -euo pipefail
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "[smoke-local] Starting ucomm-lite session..."
"$DIR/bin/ucomm-lite" start || { echo "Failed to start ucomm-lite"; exit 1; }

echo "[smoke-local] Waiting for session initialization..."
sleep 2

echo "[smoke-local] Testing tell commands..."
"$DIR/bin/tell" boss manager "hello from boss" || { echo "Failed: boss->manager"; exit 1; }
"$DIR/bin/tell" manager s1 "dispatch to s1" || { echo "Failed: manager->s1"; exit 1; }
"$DIR/bin/tell" s1 manager "ack from s1" || { echo "Failed: s1->manager"; exit 1; }
"$DIR/bin/tell" manager s2 "dispatch to s2" || { echo "Failed: manager->s2"; exit 1; }

echo "[smoke-local] âœ“ All smoke tests passed successfully!"
echo "[smoke-local] Messages sent to tmux session. Attach with: $DIR/bin/ucomm-lite attach"
exit 0